# managed-cluster-validating-webhooks on Hypershift

## How it works

Managed Cluster Validating Webhooks (MCVW) is deployed into Hypershift environments via several different components.

- The webhook admission service is deployed into each hosted control plane (HCP) namespace on Hypershift management clusters, via [package-operator](https://package-operator.run/)
- The `ValidatingWebhookConfiguration` resources are deployed directly onto Hypershift hosted clusters.

## Components

### Admission service

The admission service is built into a [package operator](https://package-operator.run/) (PKO) package.

The PKO package consists of:
- [a manifest](../config/package/manifest.yaml) which lists the phases involved in the package installation, any availability and promotion tests. 
- [a resource bundle](../config/package/resources.yaml.gotmpl) which contains all the resources needed for MCVW to run in the HCP namespace. This bundle is dynamically generated by [resources.go](../build/resources.go). Each resource is annotated with a phase so that PKO knows during which phase the resource should be installed. 
- [a Containerfile](../config/package/managed-cluster-validating-webhooks-package.Containerfile) which builds the PKO package image.

You can manually rebuild or generate the resource bundle by running:

```bash
make package
```

You can manually build the PKO package image by running:
```bash
make IMG_ORG=<username> build-package-image
```

Note that the package image will follow the naming convention `quay.io/$USER/managed-cluster-validating-webhooks-hs-package`

Once a package has been built (and pushed to a public image repository) it can be manually installed on a PKO-running cluster by creating a simple `Package` spec:

```yaml
apiVersion: package-operator.run/v1alpha1
kind: Package
metadata:
  name: validation-webhook
  namespace: validation-webhook
spec:
  image: quay.io/$USER/managed-cluster-validating-webhooks-hs-package:$TAG
```

On Hypershift, the `Package` resource is distributed to HCP Namespaces via a [SelectorSyncSet](../hack/templates/00-managed-cluster-validating-webhooks-hs.SelectorSyncSet.yaml.tmpl) containing ACM Policy. The application of the SelectorSyncSet to Hive clusters (in turn distributing it to the Hypershift service clusters) is performed by [app-interface](https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/data/services/osd-operators/cicd/saas/saas-managed-cluster-validating-webhooks.yaml). 

